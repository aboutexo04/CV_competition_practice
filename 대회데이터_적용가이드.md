# 🏆 대회 데이터 적용 가이드

현재 CIFAR-10 연습용 코드를 실제 대회 데이터에 적용하는 방법입니다.

## 📋 수정 필요한 부분

### 1️⃣ 데이터셋 클래스 추가 (새로운 셀 추가)

**위치**: `## 5. 데이터셋 로드` 섹션 앞에 추가

```python
# ============================================
# 대회용 Custom Dataset 클래스
# ============================================
import pandas as pd
from PIL import Image
import os

class CompetitionDataset(Dataset):
    """
    대회 데이터용 커스텀 데이터셋

    Args:
        image_dir: 이미지 폴더 경로
        labels_df: 레이블 데이터프레임 (train용, test는 None)
        transform: Albumentations transform
    """
    def __init__(self, image_dir, labels_df=None, transform=None):
        self.image_dir = image_dir
        self.labels_df = labels_df
        self.transform = transform

        # 이미지 파일 목록
        if labels_df is not None:
            self.image_files = labels_df['image_id'].tolist()  # CSV 기준
        else:
            self.image_files = sorted(os.listdir(image_dir))   # 폴더 기준

    def __len__(self):
        return len(self.image_files)

    def __getitem__(self, idx):
        img_name = self.image_files[idx]
        img_path = os.path.join(self.image_dir, img_name)

        # 이미지 로드
        image = Image.open(img_path).convert('RGB')
        image = np.array(image)

        # 레이블 가져오기
        if self.labels_df is not None:  # Train
            label = self.labels_df[self.labels_df['image_id'] == img_name]['label'].values[0]
        else:  # Test
            label = -1  # placeholder

        # Transform 적용
        if self.transform:
            augmented = self.transform(image=image)
            image = augmented['image']

        return image, label
```

### 2️⃣ 데이터 로딩 부분 수정

**위치**: `## 5. 데이터셋 로드` 섹션

**기존 코드 (CIFAR-10):**
```python
train_dataset_raw = torchvision.datasets.CIFAR10(
    root='./data',
    train=True,
    download=True
)

test_dataset_raw = torchvision.datasets.CIFAR10(
    root='./data',
    train=False,
    download=True
)
```

**변경 후 (대회 데이터):**
```python
# ============================================
# 대회 데이터 로드
# ============================================
import pandas as pd

# CSV 파일 로드
train_df = pd.read_csv('./data/train.csv')  # 경로 수정 필요
test_df = pd.read_csv('./data/test.csv')    # 있다면

# 레이블 인코딩 (문자열 → 숫자)
from sklearn.preprocessing import LabelEncoder
label_encoder = LabelEncoder()
train_df['label'] = label_encoder.fit_transform(train_df['label'])

# 클래스 개수 확인
num_classes = len(label_encoder.classes_)
print(f"📊 클래스 개수: {num_classes}")
print(f"📊 클래스 목록: {label_encoder.classes_}")

# 데이터셋 생성
train_dataset_raw = CompetitionDataset(
    image_dir='./data/train_images',  # 경로 수정 필요
    labels_df=train_df,
    transform=None
)

test_dataset_raw = CompetitionDataset(
    image_dir='./data/test_images',   # 경로 수정 필요
    labels_df=None,
    transform=None
)

# 레이블 추출 (K-Fold용)
train_labels = train_df['label'].tolist()
```

**⚠️ 경로 수정 필수:**
- `./data/train.csv` → 실제 train CSV 경로
- `./data/train_images` → 실제 train 이미지 폴더 경로
- `./data/test_images` → 실제 test 이미지 폴더 경로

### 3️⃣ 모델 클래스 개수 수정

**위치**: K-Fold 학습 루프 내 (Cell 16)

**기존 코드:**
```python
model = timm.create_model(SELECTED_MODEL, pretrained=True, num_classes=10)
```

**변경 후:**
```python
model = timm.create_model(SELECTED_MODEL, pretrained=True, num_classes=num_classes)
```

### 4️⃣ 클래스 이름 수정

**위치**: 앙상블 예측 후 (Cell 19 하단)

**기존 코드:**
```python
class_names = ['airplane', 'automobile', 'bird', 'cat', 'deer',
               'dog', 'frog', 'horse', 'ship', 'truck']
```

**변경 후:**
```python
# 대회 클래스 이름 사용
class_names = label_encoder.classes_.tolist()
```

### 5️⃣ USE_SUBSET 설정 변경

**위치**: `## 5. 데이터셋 로드` 섹션 (Cell 13)

**연습용:**
```python
USE_SUBSET = True   # 10% 데이터 사용
SUBSET_RATIO = 0.1
```

**대회 제출용:**
```python
USE_SUBSET = False  # 전체 데이터 사용 ⭐⭐⭐
SUBSET_RATIO = 1.0
```

---

## 📊 대회 데이터 구조 예시

대회 데이터가 다음과 같은 구조라고 가정:

```
data/
├── train.csv              # image_id, label 컬럼
├── test.csv               # image_id 컬럼 (레이블 없음)
├── train_images/          # 학습 이미지 폴더
│   ├── img_001.jpg
│   ├── img_002.jpg
│   └── ...
└── test_images/           # 테스트 이미지 폴더
    ├── test_001.jpg
    ├── test_002.jpg
    └── ...
```

**train.csv 예시:**
```csv
image_id,label
img_001.jpg,cat
img_002.jpg,dog
img_003.jpg,cat
```

---

## ✅ 수정 체크리스트

- [ ] CompetitionDataset 클래스 추가
- [ ] 데이터 로딩 코드 수정 (CSV 경로, 이미지 폴더 경로)
- [ ] LabelEncoder로 레이블 인코딩
- [ ] num_classes 변수 생성 및 적용
- [ ] class_names를 label_encoder.classes_로 변경
- [ ] USE_SUBSET = False로 변경 (전체 데이터 사용)
- [ ] Image Size 확인 (대회 이미지 크기에 맞게 조정)

---

## 🚀 실행 순서

1. **대회 데이터 다운로드** → `data/` 폴더에 배치
2. **위 수정사항 적용** → 5개 부분만 수정
3. **이미지 크기 확인** → `IMAGE_SIZE` 변수 조정 (필요시)
4. **USE_SUBSET = False** → 전체 데이터로 학습
5. **학습 실행** → 나머지 코드는 그대로 사용!

---

## 💡 추가 팁

### 이미지 크기 최적화
대회 이미지 크기 확인 후 설정:
```python
IMAGE_SIZE = 224  # EfficientNet 권장
IMAGE_SIZE = 384  # 고해상도 필요시
```

### 배치 크기 조정
메모리에 맞게 조정:
```python
BATCH_SIZE = 32   # 안전한 크기
BATCH_SIZE = 16   # 메모리 부족시
```

### 제출 파일 생성
테스트 예측 후 제출 파일 생성:
```python
# 제출 파일 생성
submission = pd.DataFrame({
    'image_id': test_dataset_raw.image_files,
    'label': label_encoder.inverse_transform(ensemble_preds)
})
submission.to_csv('submission.csv', index=False)
print("✅ submission.csv 생성 완료!")
```

---

## ❓ 문제 해결

### Q1: 이미지 로딩 에러
```python
# RGB로 강제 변환
image = Image.open(img_path).convert('RGB')
```

### Q2: 메모리 부족
```python
# 배치 크기 줄이기
BATCH_SIZE = 16

# num_workers 조정
num_workers = 2  # 또는 0
```

### Q3: 클래스 불균형
```python
# Weighted Loss 사용
from torch.utils.data import WeightedRandomSampler
class_counts = train_df['label'].value_counts().sort_index().values
class_weights = 1.0 / class_counts
```

---

**🎯 이 가이드대로 수정하면 바로 대회 데이터로 학습 가능합니다!**
